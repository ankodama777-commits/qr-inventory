<script>
  // ===== データ管理（localStorage） =====
  const STORAGE_KEY = "qr_inventory_data_v1";
  
  // ★必ずご自身の WebアプリURLに差し替えてください
  // 注意: GAS_URLの末尾は「/exec」で終わる必要があります。
  const GAS_URL = "https://script.google.com/macros/s/AKfycbyq97GqiQAlddNpttcp_bJZMPESGEQ1gw5se8XhV74c1bAE3UlbyQUIfGp9Nls4EZFoIQ/exec";

  // ===== ローカル在庫管理 =====
  function loadInventory() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return [];
    try {
      const data = JSON.parse(raw);
      return data.map(item => ({
        id: item.id,
        productName: item.productName || item.partNo || "",
        location: item.location || "",
        stockQty: item.stockQty ?? 0,
        lastIn: item.lastIn || "",
        lastOut: item.lastOut || "",
        partNo: item.partNo || "",
        lot: item.lot || "",
      }));
    } catch (e) {
      console.error("ローカルデータの読み込みエラー:", e);
      return [];
    }
  }

  function saveInventory(data) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    renderTable();
  }

  function findItemById(data, id) {
    return data.find(item => item.id === id);
  }

  function renderTable() {
    const data = loadInventory();
    const tbody = document.querySelector("#inventory-table tbody");
    tbody.innerHTML = "";
    data.forEach(item => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${item.id}</td> 
        <td>${item.productName || "-"}</td>
        <td>${item.location || ""}</td>
        <td>${item.stockQty ?? 0}</td>
        <td>${item.lastIn || ""}</td>
        <td>${item.lastOut || ""}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // ===== 棚番の自動整形関数 =====
  function formatLocation(input) {
    if (!input) return "";
    let cleanInput = input.trim().toUpperCase();
    // 全角文字を半角に変換
    cleanInput = cleanInput.replace(/[Ａ-Ｚａ-ｚ０-９]/g, function(s) {
      return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
    });
    // アルファベットと数字以外を除去
    cleanInput = cleanInput.replace(/[^A-Z0-9]/g, ''); 
    const match = cleanInput.match(/^([A-Z])(\d)(\d)(\d)$/);
    if (match) {
      return `${match[1]}-${match[2]}-${match[3]}-${match[4]}`;
    }
    return cleanInput;
  }

  // ===== タブ切り替え制御関数 =====
  async function switchTab(target) {
    // スキャンを確実に停止
    await stopScanner();

    document.querySelectorAll(".tab-button").forEach(b => {
      b.classList.remove("active");
      if (b.getAttribute("data-tab") === target) {
        b.classList.add("active");
      }
    });

    ["tab-inbound", "tab-outbound", "tab-list"].forEach(id => {
      document.getElementById(id).style.display = (id === target) ? "block" : "none";
    });

    const qrScannerCard = document.getElementById("qr-scanner-card");
    if (target === "tab-list") {
      qrScannerCard.style.display = "none";
    } else {
      qrScannerCard.style.display = "block";
    }

    if (target === "tab-list") {
      renderTable(); // リストタブ表示時にデータを再描画
    }
  }
  
  // タブボタンにイベントリスナーを設定
  document.querySelectorAll(".tab-button").forEach(btn => {
    btn.addEventListener("click", () => {
      switchTab(btn.getAttribute("data-tab"));
    });
  });

  // ===== GAS（在庫管理シート）参照 =====
  async function fetchInventoryByOrder(orderNo) {
    if (!GAS_URL || GAS_URL.includes("your-gas-web-app-url")) return null;
    try {
      const url = `${GAS_URL}?mode=lookup&order=${encodeURIComponent(orderNo)}`;
      const res = await fetch(url);
      if (!res.ok) return null;
      const data = await res.json();
      if (data.error) return null;
      return data;
    } catch (err) {
      console.error("GAS呼び出しでエラー", err);
      return null;
    }
  }

  // ===== GAS 書き込み：入荷・出庫（結果メッセージを返す版） =====
  async function postInboundToGas(order, itemName, location, qty) {
    if (!GAS_URL || GAS_URL.includes("your-gas-web-app-url")) return "GAS_URL が設定されていません";

    const body = new URLSearchParams({
      mode: 'inbound',
      order,
      itemName,
      location,
      qty: String(qty)
    });

    try {
      const res = await fetch(GAS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body
      });

      const text = await res.text();
      let data = null;
      try {
        data = JSON.parse(text);
      } catch (e) {
        // JSONでなければそのまま返す
        return `GAS応答(非JSON)：${text}`;
      }

      if (data.ok) {
        return "GAS連携：OK（履歴に登録されたはずです）";
      } else {
        return `GAS連携エラー：${data.error || text}`;
      }
    } catch (err) {
      return `GAS通信エラー：${err}`;
    }
  }

  async function postOutboundToGas(order, itemName, location, qty) {
    if (!GAS_URL || GAS_URL.includes("your-gas-web-app-url")) return "GAS_URL が設定されていません";

    const body = new URLSearchParams({
      mode: 'outbound',
      order,
      itemName,
      location,
      qty: String(qty)
    });

    try {
      const res = await fetch(GAS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body
      });

      const text = await res.text();
      let data = null;
      try {
        data = JSON.parse(text);
      } catch (e) {
        return `GAS応答(非JSON)：${text}`;
      }

      if (data.ok) {
        return "GAS連携：OK（履歴に登録されたはずです）";
      } else {
        return `GAS連携エラー：${data.error || text}`;
      }
    } catch (err) {
      return `GAS通信エラー：${err}`;
    }
  }

  // ===== QRスキャン処理（カメラまわり） - 信頼性向上修正済 =====
  let html5QrcodeScanner = null;
  let isScanning = false;

  function onScanSuccess(decodedText, decodedResult) {
    handleScan(decodedText, decodedResult);
    // スキャン成功後に自動停止したい場合はここで stopScanner() を呼び出す
    // stopScanner(); 
  }

  async function cleanupScanner() {
    if (html5QrcodeScanner && isScanning) {
      try {
        await html5QrcodeScanner.stop();
        console.log("Scanner stopped successfully.");
      } catch (e) {
        // Already stopped error, ignore
        console.warn("Scanner stop error (might be already stopped):", e);
      }
    }
    if (html5QrcodeScanner) {
      try {
        html5QrcodeScanner.clear();
      } catch (e) {
        console.warn("Scanner clear error:", e);
      }
    }
    html5QrcodeScanner = null;
    isScanning = false;
    document.getElementById("qr-reader").innerHTML = ""; // 描画エリアをクリア
  }

  async function startScanner() {
    // 起動前に必ずクリーンアップを試みる
    await cleanupScanner(); 

    const readerElemId = "qr-reader";
    html5QrcodeScanner = new Html5Qrcode(readerElemId);
    
    const config = {
      fps: 10,
      qrbox: { width: 200, height: 200 }
    };

    try {
      const cameras = await Html5Qrcode.getCameras();
      if (!cameras || cameras.length === 0) {
        alert("カメラが見つかりませんでした。");
        return;
      }

      // バックカメラを優先的に選択
      let targetCamera = cameras.find(camera => 
        camera.label && (camera.label.toLowerCase().includes("back") || camera.label.toLowerCase().includes("rear"))
      );
      if (!targetCamera) {
        targetCamera = cameras[cameras.length - 1]; // 見つからなければ最後のカメラ（通常は背面）
      }

      const cameraId = targetCamera?.id;
      if (!cameraId) {
        alert("カメラIDを取得できませんでした。");
        return;
      }

      await html5QrcodeScanner.start(
        cameraId,
        config,
        onScanSuccess,
        (errorMessage) => {
          // スキャン中のエラーは無視 (verbose)
        }
      );
      isScanning = true;
    } catch (err) {
      console.error(err);
      alert("カメラの起動に失敗しました。\n・ブラウザのリロード\n・カメラの許可\nを確認してください。");
      cleanupScanner();
    }
  }

  async function stopScanner() { // ★非同期関数に変更
    await cleanupScanner();
  }

  document.getElementById("btn-start-scan").addEventListener("click", startScanner);
  document.getElementById("btn-stop-scan").addEventListener("click", stopScanner);

  // ===== スキャン結果ハンドリング =====
  async function handleScan(decodedText, decodedResult) {
    document.getElementById("last-scan").value = decodedText;

    let scannedId = decodedText;
    let scannedProductName = "";

    const parts = decodedText.split("|");
    if (parts.length >= 2) {
      scannedId = parts[0].trim();
      scannedProductName = parts.slice(1).join("|").trim();
    } else {
      scannedId = decodedText.trim();
      scannedProductName = "";
    }

    const localData = loadInventory();
    const localItem = findItemById(localData, scannedId);
    let localProductName = localItem ? localItem.productName : "";
    let localLocation = localItem ? localItem.location : "";

    // 入荷タブ
    document.getElementById("inbound-id").value = scannedId;
    document.getElementById("inbound-product-name").value = scannedProductName || localProductName;

    // 使用タブ
    document.getElementById("outbound-id").value = scannedId;
    document.getElementById("outbound-product-name").value =
      localProductName || scannedProductName || "未登録のオーダーIDです";
    document.getElementById("outbound-location").value = localLocation || "未登録";

    // GAS（在庫管理シート）の情報で上書き
    const gasInfo = await fetchInventoryByOrder(scannedId);
    const infoEl = document.getElementById("outbound-info");

    if (gasInfo) {
      const sheetProductName = gasInfo.itemName || gasInfo.modelName || "";
      const sheetLocation = gasInfo.location || "";
      const sheetStock = gasInfo.stockQty ?? 0;

      if (sheetProductName) {
        document.getElementById("inbound-product-name").value = sheetProductName;
        document.getElementById("outbound-product-name").value = sheetProductName;
      }
      if (sheetLocation) {
        document.getElementById("inbound-location").value = sheetLocation;
        document.getElementById("outbound-location").value = sheetLocation;
      }

      if (infoEl) {
        infoEl.textContent = `シート在庫：棚番 ${sheetLocation || "-"} / 在庫 ${sheetStock}`;
      }
    } else {
      if (infoEl) {
        infoEl.textContent = "スプレッドシートに在庫情報が見つかりませんでした。ローカルデータのみ表示しています。";
      }
    }
  }

  // ===== 入荷登録（ローカル＋GAS・メッセージ表示） =====
  document.getElementById("btn-inbound-save").addEventListener("click", async () => {
    const id = document.getElementById("inbound-id").value.trim();
    const productName = document.getElementById("inbound-product-name").value.trim();
    const qty = Number(document.getElementById("inbound-qty").value || 0);
    const inputLocation = document.getElementById("inbound-location").value;
    const msgEl = document.getElementById("inbound-message");
    // メッセージを一旦クリア
    msgEl.textContent = ""; 

    if (!id || qty <= 0) {
      msgEl.textContent = "オーダーIDと数量は必須です。";
      return;
    }

    const location = formatLocation(inputLocation);
    const data = loadInventory();
    let item = findItemById(data, id);
    const now = new Date().toLocaleString();

    if (!item) {
      item = {
        id,
        productName: productName,
        partNo: "",
        lot: "",
        location,
        stockQty: 0,
        lastIn: "",
        lastOut: ""
      };
      data.push(item);
    }

    if (location) item.location = location;
    if (productName) item.productName = productName;

    item.stockQty = (item.stockQty || 0) + qty;
    item.lastIn = now;

    // フォームをクリア（IDは次の作業のために残しておくことが多いですが、品名/数量/棚番をクリア）
    // document.getElementById("inbound-id").value = ""; 
    document.getElementById("inbound-location").value = location; // 整形後の棚番をフォームに反映
    document.getElementById("inbound-product-name").value = "";
    document.getElementById("inbound-qty").value = "1";

    saveInventory(data);
    msgEl.textContent =
      `✅ 入荷登録完了！（オーダーID: ${id} / +${qty} / 棚番: ${location || '-'}）`;

    // 本番シート側へも入荷登録（入出庫履歴→在庫管理反映）
    const gasResult = await postInboundToGas(id, item.productName || "", location, qty);
    msgEl.textContent += ` / ${gasResult}`;
  });

  // ===== 使用/数量調整（ローカル＋GAS・メッセージ表示） =====
  document.getElementById("btn-outbound-exec").addEventListener("click", async () => {
    const id = document.getElementById("outbound-id").value.trim();
    const qty = Number(document.getElementById("outbound-qty").value || 0);
    const infoEl = document.getElementById("outbound-info");
    // メッセージを一旦クリア
    infoEl.textContent = "";

    if (!id || qty <= 0) {
      infoEl.textContent = "オーダーIDと使用数量は必須です。";
      return;
    }

    const data = loadInventory();
    const item = findItemById(data, id);
    if (!item) {
      infoEl.textContent = "該当するオーダーIDの在庫が見つかりません。";
      return;
    }

    const current = item.stockQty || 0;
    if (current < qty) {
      infoEl.textContent = `在庫不足です。現在の在庫：${current}`;
      return;
    }

    item.stockQty = current - qty;
    item.lastOut = new Date().toLocaleString() + "（使用）";
    saveInventory(data);

    infoEl.textContent =
      `✅ 使用を処理しました。（オーダーID: ${id} / -${qty} / 残：${item.stockQty}）`;

    // 本番シート側へも出庫登録
    const gasResult = await postOutboundToGas(id, item.productName || "", item.location || "", qty);
    infoEl.textContent += ` / ${gasResult}`;
  });

  // ===== CSVダウンロード =====
  document.getElementById("btn-download-csv").addEventListener("click", () => {
    const data = loadInventory();
    if (data.length === 0) {
      alert("データがありません。");
      return;
    }

    const header = ["id", "productName", "location", "stockQty", "lastIn", "lastOut"];
    const rows = [header.join(",")];

    data.forEach(item => {
      const row = [
        item.id,
        item.productName || "",
        item.location || "",
        item.stockQty ?? 0,
        (item.lastIn || "").replace(/,/g, " "),
        (item.lastOut || "").replace(/,/g, " ")
      ];
      rows.push(row.map(v => `"${String(v).replace(/"/g, '""')}"`).join(","));
    });

    const blob = new Blob([rows.join("\r\n")], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "inventory_export.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  // ===== 全データ削除（テスト用） =====
  document.getElementById("btn-clear-all").addEventListener("click", () => {
    if (!confirm("⚠️本当に全データを削除しますか？（ローカルストレージ内の全在庫が失われます）")) return;
    localStorage.removeItem(STORAGE_KEY);
    renderTable();
  });

  // ★ 初期化処理: ページロード時に実行し、初期表示を制御する
  function init() {
    // デフォルトで「入荷登録」タブを表示
    switchTab("tab-inbound"); 
    renderTable();
  }

  // ページロードが完了したら初期化を実行
  window.addEventListener('load', init);
  // init();
</script>
