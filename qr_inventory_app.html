<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>在庫管理</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <style>
    /* (スタイルシートは省略) */
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin: 0; padding: 0; background: #f5f5f7; color: #222; }
    header { background: #1d1d1f; color: #fff; padding: 12px 16px; text-align: center; font-size: 18px; font-weight: 600; display: flex; justify-content: center; align-items: center; gap: 8px; }
    .header-title { font-size: 18px; font-weight: 600; margin: 0; }
    .header-version { font-size: 12px; font-weight: 400; color: #aaa; }
    .container { padding: 12px; max-width: 900px; margin: 0 auto; }
    .tabs { display: flex; gap: 4px; margin-bottom: 10px; overflow-x: auto; }
    .tab-button { flex: 1; padding: 8px; border-radius: 999px; border: none; background: #e0e0e5; font-size: 13px; white-space: nowrap; }
    .tab-button.active { background: #0070c9; color: #fff; font-weight: 600; }
    .card { background: #fff; border-radius: 12px; padding: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); margin-bottom: 12px; }
    .card h2 { font-size: 16px; margin: 0 0 8px; }
    label { display: block; font-size: 13px; margin-top: 6px; }
    input, button { font-family: inherit; font-size: 14px; }
    input[type="text"], input[type="number"] { width: 100%; padding: 8px; box-sizing: border-box; border-radius: 8px; border: 1px solid #ccc; margin-top: 3px; }
    button.primary { background: #0070c9; color: #fff; border: none; border-radius: 999px; padding: 8px 16px; margin-top: 10px; }
    button.secondary { background: #e0e0e5; border: none; border-radius: 999px; padding: 8px 12px; margin-top: 10px; font-size: 12px; }
    .small { font-size: 12px; color: #666; }
    .field-row { display: flex; gap: 8px; margin-top: 6px; }
    .field-cell { flex: 1; }
    .field-cell label { margin-top: 0; }
    .scan-controls-row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .scan-mode { margin-top: 6px; }
    .scan-mode label { display: inline-flex; align-items: center; gap: 6px; margin-top: 0; font-size: 12px; color: #444; }
    .last-scan-label { display: block; font-size: 12px; margin-top: 10px; color: #555; }
    .last-scan-box { margin-top: 4px; padding: 6px 8px; min-height: 32px; border-radius: 8px; background: #f0f0f5; border: 1px dashed #bbb; font-size: 13px; color: #333; word-break: break-all; pointer-events: none; }
    .big-location-box { margin-top: 4px; margin-bottom: 8px; padding: 12px 8px; border-radius: 12px; background: #fff7e0; border: 2px solid #f5b800; font-size: 24px; font-weight: 700; text-align: center; letter-spacing: 0.08em; color: #b36b00; min-height: 40px; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
  </style>
</head>

<body>
<header>
  <span class="header-title">在庫管理</span>
  <span id="app-version-display" class="header-version"></span>
</header>

<div class="container">

  <div class="tabs">
    <button class="tab-button active" data-tab="tab-inbound">入荷登録</button>
    <button class="tab-button" data-tab="tab-use">使用 / 調整</button>
  </div>

  <div class="card" id="qr-scanner-card">
    <h2>QRスキャン</h2>

    <div class="scan-controls-row">
      <button id="btn-start-scan" class="primary">スキャン開始</button>
      <button id="btn-stop-scan" class="secondary">停止</button>
    </div>

    <div class="scan-mode">
      <label>
        <input type="checkbox" id="scan-mode-toggle" checked />
        連続スキャン（オフで1回読み取りごとに停止）
      </label>
    </div>

    <div id="qr-reader" style="margin-top:10px;"></div>

    <span class="last-scan-label">直近の読み取り</span>
    <div id="last-scan" class="last-scan-box"></div>
    
    <div class="card" style="margin-top:12px; background:#fff3e0; border: 1px solid #ffcc80; padding: 8px;">
      <h2 style="font-size: 14px; margin-bottom: 4px;">[デバッグ情報] QR解析結果</h2>
      <p style="font-size:12px; margin: 4px 0;">
        オーダーID (キー): <strong id="debug-order" style="color: #c90000;"></strong><br>
        機種名: <span id="debug-model"></span><br>
        品名: <span id="debug-name"></span>
      </p>
    </div>
  </div>

  <div id="tab-inbound" class="card">
    <h2>入荷 <span class="small">IN</span></h2>
    <div class="field-row">
      <div class="field-cell">
        <label>オーダーID</label>
        <input type="text" id="inbound-id" />
      </div>
      <div class="field-cell">
        <label>機種名（任意）</label>
        <input type="text" id="inbound-model" />
      </div>
    </div>
    <label>品名</label>
    <input type="text" id="inbound-name" />
    <div class="field-row">
      <div class="field-cell">
        <label>棚番</label>
        <input type="text" id="inbound-loc" />
      </div>
      <div class="field-cell">
        <label>数量</label>
        <input type="number" id="inbound-qty" min="1" value="1" />
      </div>
    </div>
    <button id="btn-inbound-save" class="primary">入荷を登録</button>
    <div id="inbound-msg" class="small"></div>
  </div>

  <div id="tab-use" class="card" style="display:none;">
    <div id="big-location" class="big-location-box"></div>
    <div class="field-row">
      <div class="field-cell">
        <label>オーダーID</label>
        <input type="text" id="use-id" />
      </div>
      <div class="field-cell">
        <label>機種名</label>
        <input type="text" id="use-model" readonly />
      </div>
    </div>
    <label>品名</label>
    <input type="text" id="use-name" readonly />
    <input type="hidden" id="use-loc" />
    <div class="field-row">
      <div class="field-cell">
        <label>使用数量</label>
        <input type="number" id="use-qty" min="1" value="1" />
      </div>
      <div class="field-cell">
        <label>現在庫（GAS側で返却される場合）</label>
        <input type="text" id="use-stock" readonly />
      </div>
    </div>
    <button id="btn-use-save" class="primary">使用 / 数量調整を登録</button>
    <div id="use-msg" class="small"></div>
  </div>
</div>

<audio id="audio-scan" src="scan-ok.mp3" preload="auto"></audio>
<audio id="audio-success" src="success.mp3" preload="auto"></audio>

<script>
/************************************************************
 * アプリ設定
 ************************************************************/
const APP_VERSION = "v1.2"; // ★バージョンを v1.2 に設定 (強制QR解析値採用)
// ★★★ ここを最新のGASデプロイURLに置き換えてください ★★★
const GAS_URL = "https://script.google.com/macros/s/AKfycbw7XpM4DdL5OgqvG6iiwdjROr4vkHBYEHl8L3kCHX2hExmWoo_xv3DX3rKojg-03b0t/exec"; 

// ページロード時にバージョン番号をヘッダーに表示
document.addEventListener("DOMContentLoaded", () => {
    const versionEl = document.getElementById("app-version-display");
    if (versionEl) {
        versionEl.textContent = APP_VERSION;
    }
});


/************************************************************
 * 共通関数群 (中略)
 ************************************************************/
function normalizeLocation(raw) {
  if (!raw) return "";
  let s = raw.trim().toUpperCase();
  s = s.replace(/[^A-Z0-9]/g, ""); 
  if (!s) return "";
  const first = s.charAt(0);
  const rest = s.slice(1).split("");
  return [first, ...rest].join("-");
}
function vibrate(pattern) { if (navigator.vibrate) { navigator.vibrate(pattern); } }
function playSound(id) {
  const el = document.getElementById(id);
  if (!el) return;
  try { el.currentTime = 0; el.play().catch(() => {}); } catch (e) {}
}
function notifyScan() { vibrate(50); playSound("audio-scan"); }
function notifySuccess() { vibrate([40, 60, 40]); playSound("audio-success"); }

// GAS通信関数群 (中略)
async function sendInbound(id, name, loc, qty, model) {
  const body = new URLSearchParams({ mode: "inbound", order: id, itemName: name, location: loc, qty: qty, modelName: model || "" });
  const res = await fetch(GAS_URL, { method: "POST", body: body });
  return await res.json();
}
async function sendOutbound(id, name, loc, qty, model) {
  const body = new URLSearchParams({ mode: "outbound", order: id, itemName: name, location: loc, qty: qty, modelName: model || "" });
  const res = await fetch(GAS_URL, { method: "POST", body: body });
  return await res.json();
}
async function lookup(order) {
  const url = `${GAS_URL}?mode=lookup&order=${encodeURIComponent(order)}`;
  const res = await fetch(url);
  return await res.json();
}


let html5Scanner = null;
let continuousScan = true;
const scanModeToggle = document.getElementById("scan-mode-toggle");
if (scanModeToggle) {
  continuousScan = scanModeToggle.checked;
  scanModeToggle.addEventListener("change", (e) => {
    continuousScan = e.target.checked;
  });
}

/************************************************************
 * QRスキャン開始
 ************************************************************/
const btnStartScan = document.getElementById("btn-start-scan");
if (btnStartScan) {
  btnStartScan.addEventListener("click", async () => {
    if (html5Scanner) {
      try { await html5Scanner.stop(); } catch (e) {}
      html5Scanner.clear();
      html5Scanner = null;
    }
    if (typeof Html5Qrcode === "undefined") {
      alert("カメラライブラリが読み込めていません。");
      return;
    }

    html5Scanner = new Html5Qrcode("qr-reader");

    html5Scanner.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 200 },
      async (decoded) => {
        const lastScan = document.getElementById("last-scan");
        if (lastScan) lastScan.textContent = decoded;
        notifyScan();

        // **【v1.2 確定版】QRコード解析ロジック**
        let order = decoded;
        let name  = "";
        let model = "";
        
        let delimiter = '';
        if (decoded.includes("|")) {
            delimiter = "|";
        } else if (decoded.includes("/")) {
            delimiter = "/";
        } else if (decoded.includes("-")) { 
            delimiter = "-";
        }
        
        let sp = [];
        if (delimiter) {
             sp = decoded.split(delimiter).map(s => s.trim());
        }
        
        if (delimiter === '-') {
            // ★ハイフン区切りの場合: 4要素以上あれば、オーダーIDは常に最初の4つ、機種名/品名はその後ろの要素から抽出
            
            if (sp.length >= 4) {
                // オーダーID: 1～4要素を結合 (ABCD-00-01) - 厳密に4要素のみを使用
                order = sp.slice(0, 4).join("-"); 
                
                // 機種名: 5要素目 (インデックス4)
                model = sp[4] || ""; 
                
                // 品名: 6要素目 (インデックス5)
                name  = sp[5] || ""; 

            } else {
                // 要素数が4つ未満の場合は、全てをオーダーIDとしてlookupさせる
                order = decoded;
            }
        } else if (delimiter === '|' || delimiter === '/') {
            // | または / 区切りの場合 (ABCD-00-01|部品５|123 を想定)
            if (sp.length >= 3) {
                // オーダーID: 1要素目
                order = sp[0] || decoded;
                // 品名: 2要素目
                name  = sp[1] || "";
                // 機種名: 3要素目
                model = sp[2] || "";
            } else if (sp.length === 2) {
                // 2要素の場合
                order = sp[0] || decoded;
                name  = sp[1] || "";
                model = "";
            } else {
                // 分割できない場合
                order = decoded;
            }
        } else {
            // 分割記号がない場合
            order = decoded;
        }

        // デバッグ情報表示
        document.getElementById("debug-order").textContent = order;
        document.getElementById("debug-model").textContent = model;
        document.getElementById("debug-name").textContent = name;

        // 入力要素の取得
        const inId    = document.getElementById("inbound-id");
        const inName  = document.getElementById("inbound-name");
        const inModel = document.getElementById("inbound-model");
        const inLoc   = document.getElementById("inbound-loc");
        const useId    = document.getElementById("use-id");
        const useName  = document.getElementById("use-name");
        const useLoc   = document.getElementById("use-loc");
        const useModel = document.getElementById("use-model");
        const useStock = document.getElementById("use-stock");
        const bigLoc = document.getElementById("big-location");

        // 入荷タブ：初期値 (QRから分離した値を設定)
        if (inId)    inId.value    = order;
        if (inName)  inName.value  = name;
        if (inModel) inModel.value = model; 

        // lookupして詳細取得
        let info = {};
        try { info = await lookup(order); } catch (e) { info = { error: "lookup failed" }; }

        if (!info.error) {
          // GAS側から返された情報を取得
          const gasOrder  = info.order || order;
          const gasModel  = info.modelName || model; 
          const locNorm   = normalizeLocation(info.location || "");
          const itemName  = info.itemName || name; 
          const stockQty = info.stockQty !== undefined && info.stockQty !== null ? info.stockQty : "";

          // 入荷タブ (lookup結果で上書き)
          if (inId)    inId.value    = order; // ★★★ v1.2 修正点: QR解析値 (order) を強制採用 ★★★
          if (inName)  inName.value  = itemName;
          if (inLoc)   inLoc.value   = locNorm;
          if (inModel) inModel.value = gasModel;

          // 使用 / 調整タブ (lookup結果をセット)
          if (useId)    useId.value    = order; // ★★★ v1.2 修正点: QR解析値 (order) を強制採用 ★★★
          if (useName)  useName.value  = itemName;
          if (useLoc)   useLoc.value   = locNorm;
          if (useModel) useModel.value = gasModel;
          if (useStock) useStock.value = stockQty;
          if (bigLoc)   bigLoc.textContent = locNorm;
        } else {
          // lookup失敗時は、QR情報のみをセット
          if (useId)    useId.value    = order;
          if (useName)  useName.value  = name;
          if (useModel) useModel.value = model;
          if (useStock) useStock.value = "";
          if (bigLoc)   bigLoc.textContent = ""; 
          if (useLoc)   useLoc.value   = "";
        }

        if (!continuousScan && html5Scanner) {
          try { await html5Scanner.stop(); } catch (e) {}
          html5Scanner.clear();
          html5Scanner = null;
        }
      },
      (errorMessage) => {}
    );
  });
}

// ... (以下、各種イベントリスナーは v1.1から変更なし) ...

const btnStopScan = document.getElementById("btn-stop-scan");
if (btnStopScan) {
  btnStopScan.addEventListener("click", async () => {
    if (html5Scanner) {
      try { await html5Scanner.stop(); } catch (e) {}
      html5Scanner.clear();
      html5Scanner = null;
    }
  });
}

const btnInboundSave = document.getElementById("btn-inbound-save");
if (btnInboundSave) {
  btnInboundSave.addEventListener("click", async () => {
    const id = (document.getElementById("inbound-id") || {}).value?.trim() ?? "";
    const name = (document.getElementById("inbound-name") || {}).value?.trim() ?? "";
    const qtyEl = document.getElementById("inbound-qty");
    const model = (document.getElementById("inbound-model") || {}).value?.trim() ?? "";
    const qty = qtyEl ? Number(qtyEl.value) : 0;
    const locInput = document.getElementById("inbound-loc");
    let locRaw = locInput ? locInput.value.trim() : "";
    const loc = normalizeLocation(locRaw);
    if (locInput) locInput.value = loc;
    const msg = document.getElementById("inbound-msg");
    if (!id || !qty) {
      if (msg) msg.textContent = "IDと数量は必須です。";
      return;
    }
    let res = {};
    try { res = await sendInbound(id, name, loc, qty, model); } catch (e) { res = { ok: false }; }
    if (msg) {
      if (res.ok) { msg.textContent = "入荷登録：GAS OK"; notifySuccess(); } 
      else { msg.textContent = "入荷登録：GAS ERROR"; }
    }
  });
}

const btnUseSave = document.getElementById("btn-use-save");
if (btnUseSave) {
  btnUseSave.addEventListener("click", async () => {
    const id = (document.getElementById("use-id") || {}).value?.trim() ?? "";
    const name = (document.getElementById("use-name") || {}).value?.trim() ?? "";
    const qtyEl = document.getElementById("use-qty");
    const model = (document.getElementById("use-model") || {}).value?.trim() ?? "";
    const qty = qtyEl ? Number(qtyEl.value) : 0;
    const locInput = document.getElementById("use-loc");
    let locRaw = locInput ? locInput.value.trim() : "";
    const loc = normalizeLocation(locRaw);
    if (locInput) locInput.value = loc;
    const bigLoc = document.getElementById("big-location");
    if (bigLoc) bigLoc.textContent = loc;
    const msg = document.getElementById("use-msg");
    if (!id || !qty) {
      if (msg) msg.textContent = "IDと使用数量は必須です。";
      return;
    }
    let res = {};
    try { res = await sendOutbound(id, name, loc, qty, model); } catch (e) { res = { ok: false }; }
    if (msg) {
      if (res.ok) { msg.textContent = "使用 / 数量調整：GAS OK"; notifySuccess(); } 
      else { msg.textContent = "使用 / 数量調整：GAS ERROR"; }
    }
  });
}

const inboundLocInput = document.getElementById("inbound-loc");
if (inboundLocInput) {
  inboundLocInput.addEventListener("blur", () => {
    inboundLocInput.value = normalizeLocation(inboundLocInput.value);
  });
}

document.querySelectorAll(".tab-button").forEach((btn) => {
  btn.addEventListener("click", () => {
    document
      .querySelectorAll(".tab-button")
      .forEach((b) => b.classList.remove("active"));
    btn.classList.add("active");
    const tab = btn.dataset.tab;
    document.querySelectorAll(".card").forEach((c) => {
      if (c.id === "qr-scanner-card") return; 
      c.style.display = (c.id === tab) ? "block" : "none";
    });
  });
});
</script>
</body>
</html>
