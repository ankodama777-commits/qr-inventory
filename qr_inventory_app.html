<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>在庫管理</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin: 0; padding: 0; background: #f5f5f7; color: #222; }
    header { background: #1d1d1f; color: #fff; padding: 12px 16px; text-align: center; font-size: 18px; font-weight: 600;
             display: flex; justify-content: center; align-items: center; gap: 8px; }
    .header-title { font-size: 18px; font-weight: 600; margin: 0; }
    .header-version { font-size: 12px; font-weight: 400; color: #aaa; }
    .container { padding: 12px; max-width: 900px; margin: 0 auto; }
    .tabs { display: flex; gap: 4px; margin-bottom: 10px; overflow-x: auto; }
    .tab-button { flex: 1; padding: 8px; border-radius: 999px; border: none; background: #e0e0e5;
                  font-size: 13px; white-space: nowrap; }
    .tab-button.active { background: #0070c9; color: #fff; font-weight: 600; }
    .card { background: #fff; border-radius: 12px; padding: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); margin-bottom: 12px; }
    .card h2 { font-size: 16px; margin: 0 0 8px; }
    label { display: block; font-size: 13px; margin-top: 6px; }
    input, button { font-family: inherit; font-size: 14px; }
    input[type="text"], input[type="number"] {
      width: 100%; padding: 8px; box-sizing: border-box;
      border-radius: 8px; border: 1px solid #ccc; margin-top: 3px;
    }
    button.primary { background: #0070c9; color: #fff; border: none; border-radius: 999px; padding: 8px 16px; margin-top: 10px; }
    button.secondary { background: #e0e0e5; border: none; border-radius: 999px; padding: 8px 12px; margin-top: 10px; font-size: 12px; }
    .small { font-size: 12px; color: #666; }
    .field-row { display: flex; gap: 8px; margin-top: 6px; }
    .field-cell { flex: 1; }
    .field-cell label { margin-top: 0; }

    /* 未登録表示用ボックス */
    .big-location-box {
      margin-top: 4px; margin-bottom: 8px;
      padding: 12px 8px; border-radius: 12px;
      font-size: 24px; font-weight: 700;
      text-align: center; letter-spacing: 0.08em;
      min-height: 40px;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }
  </style>
</head>

<body>
<header>
  <span class="header-title">在庫管理</span>
  <span id="app-version-display" class="header-version"></span>
</header>

<div class="container">

  <div class="tabs">
    <button class="tab-button active" data-tab="tab-inbound">入荷登録</button>
    <button class="tab-button" data-tab="tab-use">使用 / 調整</button>
  </div>

  <div class="card" id="qr-scanner-card">
    <h2>QRスキャン</h2>

    <div class="scan-controls-row" style="display:flex; gap:8px;">
      <button id="btn-start-scan" class="primary">スキャン開始</button>
      <button id="btn-stop-scan" class="secondary">停止</button>
    </div>

    <div class="scan-mode">
      <label>
        <input type="checkbox" id="scan-mode-toggle" checked />
        連続スキャン（オフで1回ごとに停止）
      </label>
    </div>

    <div id="qr-reader" style="margin-top:10px;"></div>

    <span class="last-scan-label">直近の読み取り</span>
    <div id="last-scan" class="last-scan-box"
         style="margin-top:4px; padding:6px 8px; min-height:32px; border-radius:8px;
                background:#f0f0f5; border:1px dashed #bbb; font-size:13px;"></div>
  </div>

  <!-- 入荷 -->
  <div id="tab-inbound" class="card">
    <h2>入荷 <span class="small">IN</span></h2>

    <div class="field-row">
      <div class="field-cell">
        <label>オーダーID</label>
        <input type="text" id="inbound-id" />
      </div>
      <div class="field-cell">
        <label>機種名（任意）</label>
        <input type="text" id="inbound-model" />
      </div>
    </div>

    <label>品名</label>
    <input type="text" id="inbound-name" />

    <div class="field-row">
      <div class="field-cell">
        <label>棚番</label>
        <input type="text" id="inbound-loc" />
      </div>
      <div class="field-cell">
        <label>数量（D列の予定数）</label>
        <input type="number" id="inbound-qty" min="0" value="0" />
      </div>
    </div>

    <button id="btn-inbound-save" class="primary">入荷を登録</button>
    <div id="inbound-msg" class="small"></div>
  </div>

  <!-- 使用 / 調整 -->
  <div id="tab-use" class="card" style="display:none;">
    <div id="big-location" class="big-location-box"></div>

    <div class="field-row">
      <div class="field-cell">
        <label>オーダーID</label>
        <input type="text" id="use-id" />
      </div>
      <div class="field-cell">
        <label>機種名</label>
        <input type="text" id="use-model" readonly />
      </div>
    </div>

    <label>品名</label>
    <input type="text" id="use-name" readonly />

    <input type="hidden" id="use-loc" />

    <div class="field-row">
      <div class="field-cell">
        <label>使用数量</label>
        <input type="number" id="use-qty" min="1" value="1" />
      </div>
      <div class="field-cell">
        <label>現在庫（D列の数量予定）</label>
        <input type="text" id="use-stock" readonly />
      </div>
    </div>

    <button id="btn-use-save" class="primary">使用 / 数量調整を登録</button>
    <div id="use-msg" class="small"></div>
  </div>

</div>

<audio id="audio-scan" src="scan-ok.mp3" preload="auto"></audio>
<audio id="audio-success" src="success.mp3" preload="auto"></audio>

<script>
/************************************************************
 * アプリ設定
 ************************************************************/
const APP_VERSION = "v1.6";

// ★★★ 必ずあなたの最新 GAS デプロイURLに貼り替えてください ★★★
const GAS_URL = "https://script.google.com/macros/s/AKfycbxxf5fpUYsJnIckzdxijM6u2cpfIujPasPrsoq-pDTEM1-H9LJOsNTHtwSWHMV5_sRykg/exec";

document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("app-version-display").textContent = APP_VERSION;
});


/************************************************************
 * 共通関数
 ************************************************************/
function normalizeLocation(raw) {
  if (!raw) return "";
  let s = raw.trim().toUpperCase();
  s = s.replace(/[^A-Z0-9]/g, "");
  if (!s) return "";
  const first = s.charAt(0);
  const rest = s.slice(1).split("");
  return [first, ...rest].join("-");
}

function vibrate(p) { if (navigator.vibrate) navigator.vibrate(p); }
function playSound(id) {
  const el = document.getElementById(id);
  if (!el) return;
  try { el.currentTime = 0; el.play().catch(()=>{}); } catch(e){}
}
function notifyScan(){ vibrate(50); playSound("audio-scan"); }
function notifySuccess(){ vibrate([40,60,40]); playSound("audio-success"); }

async function sendInbound(id,name,loc,qty,model){
  const body = new URLSearchParams({ mode:"inbound", order:id, itemName:name, location:loc, qty:qty, modelName:model||"" });
  const r = await fetch(GAS_URL,{method:"POST",body});
  return await r.json();
}
async function sendOutbound(id,name,loc,qty,model){
  const body = new URLSearchParams({ mode:"outbound", order:id, itemName:name, location:loc, qty:qty, modelName:model||"" });
  const r = await fetch(GAS_URL,{method:"POST",body});
  return await r.json();
}
async function lookup(order){
  const r = await fetch(`${GAS_URL}?mode=lookup&order=${encodeURIComponent(order)}`);
  return await r.json();
}


let html5Scanner = null;
let continuousScan = true;

document.getElementById("scan-mode-toggle").addEventListener("change",e=>{
  continuousScan = e.target.checked;
});


/************************************************************
 * QRスキャン開始
 ************************************************************/
document.getElementById("btn-start-scan").addEventListener("click", async()=>{

  if (html5Scanner) {
    try{ await html5Scanner.stop(); }catch(e){}
    html5Scanner.clear(); html5Scanner=null;
  }

  html5Scanner = new Html5Qrcode("qr-reader");

  html5Scanner.start(
    { facingMode:"environment" },
    { fps:10, qrbox:200 },
    async decoded => {

      notifyScan();

      const lastScan = document.getElementById("last-scan");
      if (lastScan) lastScan.textContent = decoded;

      // ========= QR解析 =========
      let order = decoded;
      let name = "";
      let model = "";

      let delimiter="";
      if(decoded.includes("|")) delimiter="|";
      else if(decoded.includes("/")) delimiter="/";
      else if(decoded.includes("-")) delimiter="-";

      let sp=[];
      if(delimiter) sp = decoded.split(delimiter).map(s=>s.trim());

      if (delimiter==="-" && sp.length>=4) {
        order = sp.slice(0,4).join("-");
        model = sp[4]||"";
        name  = sp[5]||"";
      } else if (delimiter==="|" && sp.length>=2) {
        order = sp[0];
        name  = sp[1]||"";
        model = sp[2]||"";
      }

      const inId=document.getElementById("inbound-id");
      const inName=document.getElementById("inbound-name");
      const inModel=document.getElementById("inbound-model");
      const inLoc=document.getElementById("inbound-loc");
      const inQty=document.getElementById("inbound-qty");

      const useId=document.getElementById("use-id");
      const useName=document.getElementById("use-name");
      const useLoc=document.getElementById("use-loc");
      const useModel=document.getElementById("use-model");
      const useStock=document.getElementById("use-stock");
      const bigLoc=document.getElementById("big-location");

      // lookup 実行
      let info={};
      try{ info = await lookup(order); }catch(e){ info={error:"lookup failed"} }

      if (!info.error) {
        const locNorm = normalizeLocation(info.location||"");
        const plannedQty = Number(info.plannedQty||0);
        const gasModel = info.modelName||model;
        const gasName = info.itemName||name;

        if(inId) inId.value = order;
        if(inName) inName.value = gasName;
        if(inModel) inModel.value = gasModel;
        if(inQty) inQty.value = plannedQty;
        if(inLoc) inLoc.value = locNorm;

        if(useId) useId.value = order;
        if(useName) useName.value = gasName;
        if(useLoc) useLoc.value = locNorm;
        if(useModel) useModel.value = gasModel;
        if(useStock) useStock.value = plannedQty;

        // ★棚番表示（未登録 → 赤）
        if(bigLoc){
          if(!locNorm){
            bigLoc.textContent="未登録";
            bigLoc.style.color="#d60000";
            bigLoc.style.background="#ffecec";
            bigLoc.style.border="2px solid #ff9999";
          } else {
            bigLoc.textContent=locNorm;
            bigLoc.style.color="#b36b00";
            bigLoc.style.background="#fff7e0";
            bigLoc.style.border="2px solid #f5b800";
          }
        }

      } else {
        // lookup失敗
        if(useId) useId.value=order;
        if(useName) useName.value=name;
        if(useModel) useModel.value=model;
        if(useLoc) useLoc.value="";
        if(useStock) useStock.value="";

        if(inId) inId.value=order;
        if(inName) inName.value=name;
        if(inModel) inModel.value=model;
        if(inLoc) inLoc.value="";
        if(inQty) inQty.value=0;

        if(bigLoc){
          bigLoc.textContent="未登録";
          bigLoc.style.color="#d60000";
          bigLoc.style.background="#ffecec";
          bigLoc.style.border="2px solid #ff9999";
        }
      }

      if(!continuousScan && html5Scanner){
        try{ await html5Scanner.stop(); }catch(e){}
        html5Scanner.clear(); html5Scanner=null;
      }
    }
  );
});


/************************************************************
 * 停止
 ************************************************************/
document.getElementById("btn-stop-scan").addEventListener("click", async()=>{
  if(html5Scanner){
    try{ await html5Scanner.stop(); }catch(e){}
    html5Scanner.clear(); html5Scanner=null;
  }
});


/************************************************************
 * 入荷登録
 ************************************************************/
document.getElementById("btn-inbound-save").addEventListener("click", async()=>{

  const id = document.getElementById("inbound-id").value.trim();
  const name = document.getElementById("inbound-name").value.trim();
  const model = document.getElementById("inbound-model").value.trim();
  const qty = Number(document.getElementById("inbound-qty").value);
  let loc = document.getElementById("inbound-loc").value.trim();
  loc = normalizeLocation(loc);

  const msg = document.getElementById("inbound-msg");

  if(!id){
    msg.textContent="IDがありません。";
    msg.style.color="red";
    return;
  }
  if(qty<=0){
    msg.textContent="数量が0以下のため登録できません。";
    msg.style.color="red";
    return;
  }

  let r={};
  try{ r = await sendInbound(id,name,loc,qty,model); }catch(e){ r={ok:false}; }

  if(r.ok){
    msg.textContent="入荷登録：成功";
    msg.style.color="#0070c9";
    notifySuccess();
  } else {
    msg.textContent="入荷登録：エラー";
    msg.style.color="red";
  }
});


/************************************************************
 * 使用 / 調整登録
 ************************************************************/
document.getElementById("btn-use-save").addEventListener("click", async()=>{

  const id=document.getElementById("use-id").value.trim();
  const name=document.getElementById("use-name").value.trim();
  const model=document.getElementById("use-model").value.trim();
  const qty=Number(document.getElementById("use-qty").value);
  let loc=document.getElementById("use-loc").value.trim();
  loc = normalizeLocation(loc);

  const msg=document.getElementById("use-msg");

  if(!id){
    msg.textContent="IDがありません。";
    msg.style.color="red";
    return;
  }
  if(qty<=0){
    msg.textContent="数量が0以下です。";
    msg.style.color="red";
    return;
  }

  let r={};
  try{ r = await sendOutbound(id,name,loc,qty,model); }catch(e){ r={ok:false}; }

  if(r.ok){
    msg.textContent="使用 / 調整：成功";
    msg.style.color="#0070c9";
    notifySuccess();
  } else {
    msg.textContent="使用 / 調整：エラー";
    msg.style.color="red";
  }
});


/************************************************************
 * タブ切り替え
 ************************************************************/
document.querySelectorAll(".tab-button").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".tab-button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    const tab = btn.dataset.tab;

    document.querySelectorAll(".card").forEach(c=>{
      if(c.id==="qr-scanner-card") return;
      c.style.display = (c.id===tab) ? "block" : "none";
    });
  });
});
</script>
</body>
</html>
