<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>QR在庫管理ミニアプリ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f7;
      color: #222;
    }
    header {
      background: #1d1d1f;
      color: #fff;
      padding: 12px 16px;
      text-align: center;
      font-size: 18px;
      font-weight: 600;
    }
    .container {
      padding: 12px;
      max-width: 900px;
      margin: 0 auto;
    }
    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 10px;
      overflow-x: auto;
    }
    .tab-button {
      flex: 1;
      padding: 8px;
      border-radius: 999px;
      border: none;
      background: #e0e0e5;
      font-size: 13px;
      white-space: nowrap;
    }
    .tab-button.active {
      background: #0070c9;
      color: #fff;
      font-weight: 600;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      margin-bottom: 12px;
    }
    .card h2 {
      font-size: 16px;
      margin: 0 0 8px;
    }
    label {
      display: block;
      font-size: 13px;
      margin-top: 6px;
    }
    input, button {
      font-family: inherit;
      font-size: 14px;
    }
    input[type="text"], input[type="number"] {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-top: 3px;
    }
    button.primary {
      background: #0070c9;
      color: #fff;
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      margin-top: 10px;
    }
    button.secondary {
      background: #e0e0e5;
      border: none;
      border-radius: 999px;
      padding: 8px 12px;
      margin-top: 10px;
      font-size: 12px;
    }
    .small {
      font-size: 12px;
      color: #666;
    }
    .table-wrapper {
      max-height: 320px;
      overflow: auto;
      border-radius: 8px;
      border: 1px solid #ddd;
      background: #fff;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td {
      border-bottom: 1px solid #ddd;
      padding: 4px 3px;
      text-align: left;
    }
    th {
      background: #f0f0f5;
      position: sticky;
      top: 0;
      z-index: 1;
    }
  </style>
</head>

<body>
<header>
  QR在庫管理ミニアプリ
</header>

<div class="container">

  <!-- タブ -->
  <div class="tabs">
    <button class="tab-button active" data-tab="tab-inbound">入荷登録</button>
    <button class="tab-button" data-tab="tab-outbound">出庫</button>
    <button class="tab-button" data-tab="tab-list">ローカル在庫</button>
  </div>

  <!-- QRスキャナ -->
  <div class="card" id="qr-scanner-card">
    <h2>QRスキャン</h2>
    <button id="btn-start-scan" class="primary">スキャン開始</button>
    <button id="btn-stop-scan" class="secondary">停止</button>
    <div id="qr-reader" style="margin-top:10px;"></div>
    <label>直近の読み取り</label>
    <input type="text" id="last-scan" readonly />
  </div>

  <!-- 入荷登録 -->
  <div id="tab-inbound" class="card">
    <h2>入荷 <span class="small">IN</span></h2>

    <label>オーダーID</label>
    <input type="text" id="inbound-id" />

    <!-- 追加：機種名（任意） -->
    <label>機種名（任意）</label>
    <input type="text" id="inbound-model" />

    <label>品名</label>
    <input type="text" id="inbound-name" />

    <label>数量</label>
    <input type="number" id="inbound-qty" min="1" value="1" />

    <label>棚番</label>
    <input type="text" id="inbound-loc" />

    <button id="btn-inbound-save" class="primary">入荷を登録</button>
    <div id="inbound-msg" class="small"></div>
  </div>

  <!-- 出庫 -->
  <div id="tab-outbound" class="card" style="display:none;">
    <h2>出庫 <span class="small">OUT</span></h2>

    <label>オーダーID</label>
    <input type="text" id="outbound-id" />

    <!-- 追加：機種名（表示のみ） -->
    <label>機種名</label>
    <input type="text" id="outbound-model" readonly />

    <label>品名</label>
    <input type="text" id="outbound-name" readonly />

    <label>棚番</label>
    <input type="text" id="outbound-loc" readonly />

    <label>数量</label>
    <input type="number" id="outbound-qty" min="1" value="1" />

    <button id="btn-outbound-save" class="primary">出庫する</button>
    <div id="outbound-msg" class="small"></div>
  </div>

  <!-- ローカル在庫表示 -->
  <div id="tab-list" class="card" style="display:none;">
    <h2>ローカル在庫</h2>
    <button id="btn-clear-local" class="secondary">ローカルデータ削除</button>

    <div class="table-wrapper" style="margin-top:8px;">
      <table id="inventory-table">
        <thead>
          <tr>
            <th>オーダー</th>
            <th>機種</th>
            <th>品名</th>
            <th>棚番</th>
            <th>在庫数</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/************************************************************
 *   設定
 ************************************************************/
const GAS_URL = "https://script.google.com/macros/s/AKfycbwuCfqLxQiLMQpt34wHkl4zUNP4M3aAIdrvGfII3feW0fJxhZDRccgDdnCfs2u8K_nwcg/exec"; 
const STORAGE_KEY = "qr_inventory_data_v2";

/************************************************************
 *   棚番整形関数
 *   例: "a111" → "A-1-1-1"
 ************************************************************/
function normalizeLocation(raw) {
  if (!raw) return "";
  let s = raw.trim().toUpperCase();

  // 英数字以外を除去
  s = s.replace(/[^A-Z0-9]/g, "");
  if (!s) return "";

  const first = s.charAt(0);
  const rest = s.slice(1).split("");

  return [first, ...rest].join("-");
}

/************************************************************
 *   ローカル在庫
 ************************************************************/
function loadLocal() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return [];
  return JSON.parse(raw);
}
function saveLocal(d) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(d));
  renderLocalTable();
}

/************************************************************
 *   在庫テーブル表示
 ************************************************************/
function renderLocalTable() {
  const data = loadLocal();
  const tbody = document.querySelector("#inventory-table tbody");
  tbody.innerHTML = "";

  data.forEach(item => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.id || ""}</td>
      <td>${item.model || ""}</td>
      <td>${item.name || ""}</td>
      <td>${item.loc || ""}</td>
      <td>${item.qty}</td>
    `;
    tbody.appendChild(tr);
  });
}

/************************************************************
 *   GAS呼び出し（IN）
 ************************************************************/
async function sendInbound(id, name, loc, qty, model) {
  const body = new URLSearchParams({
    mode: "inbound",
    order: id,
    itemName: name,
    location: loc,
    qty: qty,
    modelName: model || ""
  });

  const res = await fetch(GAS_URL, {
    method: "POST",
    body: body
  });

  return await res.json();
}

/************************************************************
 *   GAS呼び出し（OUT）
 ************************************************************/
async function sendOutbound(id, name, loc, qty, model) {
  const body = new URLSearchParams({
    mode: "outbound",
    order: id,
    itemName: name,
    location: loc,
    qty: qty,
    modelName: model || ""
  });

  const res = await fetch(GAS_URL, {
    method: "POST",
    body: body
  });

  return await res.json();
}

/************************************************************
 *   lookup（QR読み後）
 ************************************************************/
async function lookup(order) {
  const url = `${GAS_URL}?mode=lookup&order=${encodeURIComponent(order)}`;
  const res = await fetch(url);
  return await res.json();
}

/************************************************************
 *   QRスキャン
 ************************************************************/
let html5Scanner = null;

document.getElementById("btn-start-scan").addEventListener("click", async () => {
  if (html5Scanner) {
    await html5Scanner.stop();
    html5Scanner.clear();
  }

  html5Scanner = new Html5Qrcode("qr-reader");
  html5Scanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 200 },
    async (decoded) => {
      document.getElementById("last-scan").value = decoded;

      // 形式「オーダー｜品名」
      let order = decoded;
      let name = "";
      if (decoded.includes("|")) {
        const sp = decoded.split("|");
        order = sp[0].trim();
        name = sp[1].trim();
      }

      // 入荷タブへセット
      document.getElementById("inbound-id").value = order;
      document.getElementById("inbound-name").value = name;

      // lookup
      const info = await lookup(order);

      if (!info.error) {
        const model = info.modelName || "";
        const locNorm = normalizeLocation(info.location || "");

        document.getElementById("inbound-name").value = info.itemName || name;
        document.getElementById("inbound-loc").value = locNorm;
        document.getElementById("inbound-model").value = model;

        document.getElementById("outbound-id").value = info.order || order;
        document.getElementById("outbound-name").value = info.itemName || name;
        document.getElementById("outbound-loc").value = locNorm;
        document.getElementById("outbound-model").value = model;
      }
    }
  );
});

document.getElementById("btn-stop-scan").addEventListener("click", async () => {
  if (html5Scanner) {
    await html5Scanner.stop();
    html5Scanner.clear();
  }
});

/************************************************************
 *   入荷登録
 ************************************************************/
document.getElementById("btn-inbound-save").addEventListener("click", async () => {
  const id = document.getElementById("inbound-id").value.trim();
  const name = document.getElementById("inbound-name").value.trim();
  const qty = Number(document.getElementById("inbound-qty").value);
  const model = document.getElementById("inbound-model").value.trim();

  const locRaw = document.getElementById("inbound-loc").value.trim();
  const loc = normalizeLocation(locRaw);
  document.getElementById("inbound-loc").value = loc; // 画面上も統一

  const msg = document.getElementById("inbound-msg");

  if (!id || !qty) {
    msg.textContent = "IDと数量は必須です。";
    return;
  }

  // ローカル更新
  const data = loadLocal();
  let item = data.find(d => d.id === id);
  if (!item) {
    item = { id, name, loc, qty: 0, model: model || "" };
    data.push(item);
  }
  item.name = name;
  item.loc = loc;
  item.model = model || item.model || "";
  item.qty += qty;
  saveLocal(data);

  // GAS送信
  const res = await sendInbound(id, name, loc, qty, model);
  msg.textContent = "入荷登録：" + (res.ok ? "GAS OK" : "GAS ERROR");
});

/************************************************************
 *   出庫
 ************************************************************/
document.getElementById("btn-outbound-save").addEventListener("click", async () => {
  const id = document.getElementById("outbound-id").value.trim();
  const name = document.getElementById("outbound-name").value.trim();
  const qty = Number(document.getElementById("outbound-qty").value);
  const model = document.getElementById("outbound-model").value.trim();

  const locRaw = document.getElementById("outbound-loc").value.trim();
  const loc = normalizeLocation(locRaw);
  document.getElementById("outbound-loc").value = loc;

  const msg = document.getElementById("outbound-msg");

  if (!id || !qty) {
    msg.textContent = "IDと数量は必須です。";
    return;
  }

  // ローカル更新
  const data = loadLocal();
  let item = data.find(d => d.id === id);
  if (!item) {
    msg.textContent = "ローカル在庫にありません。";
    return;
  }
  item.qty -= qty;
  if (item.qty < 0) item.qty = 0;
  saveLocal(data);

  // GAS送信
  const res = await sendOutbound(id, name, loc, qty, model);
  msg.textContent = "出庫処理：" + (res.ok ? "GAS OK" : "GAS ERROR");
});

/************************************************************
 *   棚番入力の自動整形（blur 時）
 ************************************************************/
document.getElementById("inbound-loc").addEventListener("blur", () => {
  const input = document.getElementById("inbound-loc");
  input.value = normalizeLocation(input.value);
});

/************************************************************
 *   ローカルデータ削除
 ************************************************************/
document.getElementById("btn-clear-local").addEventListener("click", () => {
  if (!confirm("ローカル在庫データをすべて削除します。よろしいですか？")) return;
  localStorage.removeItem(STORAGE_KEY);
  renderLocalTable();
});

/************************************************************
 *   タブ切り替え
 ************************************************************/
document.querySelectorAll(".tab-button").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");

    const tab = btn.dataset.tab;

    document.querySelectorAll(".card").forEach(c => {
      if (c.id === "qr-scanner-card") return; // スキャナーは常に表示
      c.style.display = (c.id === tab) ? "block" : "none";
    });
  });
});

/************************************************************
 * 初期表示
 ************************************************************/
renderLocalTable();
</script>
</body>
</html>
